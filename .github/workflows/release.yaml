name: Release

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing semver tag to build and upload (e.g. v0.1.0-rc.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.tag }}
    steps:
      - name: Validate semver tag
        run: |
          case "$RELEASE_TAG" in
            v*) ;;
            *)
              echo "error: tag must start with 'v'" >&2
              exit 1
              ;;
          esac

      - name: Ensure tag exists on remote
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/git/ref/tags/${RELEASE_TAG}"
          code="$(curl -sS -o /tmp/tag_check.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$api")"
          if [ "$code" != "200" ]; then
            echo "error: tag '${RELEASE_TAG}' does not exist in ${GITHUB_REPOSITORY}" >&2
            cat /tmp/tag_check.json >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum

      - name: Derive CLI version from tag
        run: |
          echo "CLI_VERSION=${RELEASE_TAG}" >> "$GITHUB_ENV"

      - name: Prepare local release notes
        run: |
          cat > /tmp/release-notes.md << 'EOF'
          Automated release artifacts for ${RELEASE_TAG}.
          EOF

      - name: Build artifacts with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --skip=publish,announce,validate --release-notes /tmp/release-notes.md
        env:
          CLI_VERSION: ${{ env.CLI_VERSION }}

      - name: Upload artifacts to GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(dist/*.tar.gz dist/checksums.txt)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "error: no release artifacts found in dist/" >&2
            ls -la dist >&2 || true
            exit 1
          fi
          gh release upload "$RELEASE_TAG" "${files[@]}" --repo "$GITHUB_REPOSITORY" --clobber
